# 先生アカウントと本番の接続

## 先生のアカウントはどこで登録した？

このアプリは**大和田門下専用**のため、「先生の新規登録」画面は**出していません**（トップのリンクもなし）。

- **過去に登録している場合**  
  以前、このアプリに「先生の新規登録」画面があった時期に、**先生としてメール・パスワードを登録**していれば、そのアカウントで「先生ログイン」から入れます。  
  - そのとき Supabase の **Authentication** にユーザーが作られ、**auth_profiles** に「そのユーザー = teacher-1（先生）」の紐付けが入っています。

- **まだ一度も登録していない場合**  
  画面上からは登録できません。**Supabase ダッシュボード**で次のどちらかが必要です。  
  1. **Authentication → Users → Add user** でメール・パスワードのユーザーを追加  
  2. **SQL Editor** で、そのユーザーの `id`（UUID）を使って、**auth_profiles** に 1 行挿入する  
     - `auth_uid` = 追加したユーザーの UUID  
     - `app_user_id` = `'teacher-1'`  
     - `email` = 登録したメールアドレス  

こうすると「先生ログイン」で、そのメール・パスワードで入れます。**先生アカウントは「Supabase 上でこの形で作る」ことと整合しています。**

---

## 接続がタイムアウトする・先生としてログインできない

「接続がタイムアウトしました。通信を確認して再度お試しください。」は、**先生ログイン**のリクエスト（Supabase へのサインイン）が 15 秒以内に返ってこないときに出ます。

次を順に確認してください。

1. **本番の環境変数（Vercel）**  
   - `NEXT_PUBLIC_SUPABASE_URL` と `NEXT_PUBLIC_SUPABASE_ANON_KEY` が、**本番で使っている Supabase プロジェクト**の値になっているか。  
   - 別プロジェクトの値や、ローカル用の値のままになっていないか。  
   - **確認方法**（下記「Vercel の環境変数の確認方法」参照）。

2. **Supabase プロジェクトの状態**  
   - ダッシュボードで該当プロジェクトを開き、**Paused（一時停止）** になっていないか。  
   - 無料プランで一定期間使っていないと Paused になることがあります。Resume してから再度ログインを試す。  
   - **確認方法**（下記「Supabase が Paused の確認方法」参照）。

3. **先生アカウントの有無**  
   - 上記「先生のアカウントはどこで登録した？」のとおり、**Supabase の Authentication にユーザー**があり、**auth_profiles に teacher-1 の紐付け**がある必要があります。  
   - なければ、ダッシュボードでユーザー追加と auth_profiles の 1 行挿入を行う。

4. **ネットワーク・ファイアウォール**  
   - 本番アプリの開いている環境（会社・学校の Wi‑Fi など）で、Supabase のドメインがブロックされていないか。

---

### Vercel の環境変数の確認方法

1. ブラウザで **https://vercel.com** を開き、ログインする。
2. 一覧から **このアプリ（レッスンスケジューラー）のプロジェクト** をクリックする。
3. 画面上方の **Settings** タブをクリックする。
4. 左メニューから **Environment Variables** をクリックする。
5. 一覧に次の 2 つがあるか、値を確認する。
   - **NEXT_PUBLIC_SUPABASE_URL**  
     - 例: `https://xxxxxxxxxxxx.supabase.co` のような形式。  
     - Supabase ダッシュボードの **Project Settings → API** にある **Project URL** と**同じ**であること。
   - **NEXT_PUBLIC_SUPABASE_ANON_KEY**  
     - 長い文字列（anon の公開鍵）。  
     - Supabase ダッシュボードの **Project Settings → API** の **Project API keys → anon public** と**同じ**であること。
6. **Production** にチェックが入っているか確認する（本番で使うため）。
7. 違う値になっている場合は **Edit** で修正し、保存する。変更後は **Redeploy** しないと本番に反映されないので、**Deployments** タブから最新のデプロイを **Redeploy** する。

**Supabase 側で正しい値を確認する手順**

1. **https://supabase.com/dashboard** を開き、ログインする。
2. 使っている **プロジェクト** をクリックする。
3. 左の **Project Settings**（歯車アイコン）→ **API** を開く。
4. **Project URL** をコピー → Vercel の `NEXT_PUBLIC_SUPABASE_URL` と一致させる。
5. **Project API keys** の **anon** の **public** をコピー → Vercel の `NEXT_PUBLIC_SUPABASE_ANON_KEY` と一致させる。

---

### Supabase が Paused の確認方法

1. ブラウザで **https://supabase.com/dashboard** を開き、ログインする。
2. プロジェクト一覧を確認する。
3. **Paused** になっているプロジェクトは、カードに **「Paused」** または **「一時停止」** と表示される。また、プロジェクト名の横やカード内に「Resume project」「再開」などのボタンが出ることがある。
4. 該当プロジェクトをクリックして中に入り、画面上部や **Settings** 付近に **「This project is paused.」** のようなメッセージが出ていないか確認する。
5. **Paused の場合の解除手順**
   - プロジェクトの **Settings** を開く（左メニューの歯車アイコン）。
   - **General** などに **「Resume project」** ボタンがあればクリックして再開する。
   - またはダッシュボードのプロジェクト一覧／プロジェクト内の案内に従い、「Resume」「Restore」などをクリックする。
6. 再開後、数分待ってから本番アプリで再度「先生ログイン」を試す。

---

## 環境変数も Paused も問題ないのに、先生ログインできない・生徒の名前が表示されない

**よくある原因：本番の Supabase プロジェクトに、テーブルやデータがまだ入っていない。**

本番用に**別の Supabase プロジェクト**を作った場合、**マイグレーション（スキーマと初期データ）をそのプロジェクトで実行していない**と、次のようになります。

- **app_users** が空 → 「名前を選択して入る」で生徒・伴奏者の名前が 1 件も出ない
- **auth_profiles** に先生の行がない、または **Authentication** にユーザーがいない → 先生ログインできない

### 本番 DB にデータが入っているか確認する

1. **https://supabase.com/dashboard** を開き、**本番で使っているプロジェクト**を開く。
2. 左メニュー **Table Editor** をクリックする。
3. **app_users** テーブルを開く。
   - **中身が空** → マイグレーションが未適用。下記「本番にマイグレーションを適用する」を行う。
   - **teacher-1 や student-1 などが並んでいる** → 名簿は入っている。この場合は「名前を選択して入る」で名前が出るはず。出ない場合はブラウザの F12 → Network でエラーになっていないか確認する。
4. **Authentication → Users** で、先生として使うメールのユーザーが 1 件あるか確認する。
5. **SQL Editor** で次を実行する：  
   `SELECT * FROM auth_profiles WHERE app_user_id = 'teacher-1';`  
   - **1 行返る** → 先生と Supabase Auth の紐付けはある。ログインできない場合はパスワードやメールの typo、別プロジェクトの env になっていないか再確認。
   - **0 行** → 先生用の紐付けがない。下記「先生アカウントを 1 件だけ用意する」を行う。

### 本番にマイグレーションを適用する

本番プロジェクトで、**次の順**に SQL を実行する（Supabase ダッシュボードの **SQL Editor** で「New query」を作り、ファイルの中身をコピー＆ペーストして Run）。

1. `supabase/migrations/20250222000000_sync_schema.sql`  
   → テーブル作成と **app_users の初期名簿**（先生・生徒・伴奏者）が入る。
2. `supabase/migrations/20250222100000_auth_profiles_trigger.sql`
3. `supabase/migrations/20250222200000_auth_profiles_rpc.sql`
4. `supabase/migrations/20250222300000_check_registered_rpc.sql`
5. `supabase/migrations/20250222400000_registered_unregistered_rpc.sql`
6. `supabase/migrations/20250222500000_teacher_only_register_anon_read.sql`

**注意**  
- すでに同じ名前のテーブルや関数がある場合はエラーになることがある。そのときは「すでに存在する」部分だけ飛ばすか、該当する CREATE 文をコメントアウトして再実行する。
- 1 の **sync_schema** で `app_users` に **ON CONFLICT (id) DO NOTHING** の INSERT があるので、2 回実行しても名簿が二重にはならない。

### 先生アカウントを 1 件だけ用意する（名簿はあるが先生ログインだけできない場合）

1. **Authentication → Users → Add user** で、先生用のメール・パスワードを 1 件追加する。
2. 追加したユーザーをクリックし、**UUID（id）** をコピーする。
3. **SQL Editor** で次を実行する（`'ここにUUID'` と `'先生のメール'` を実際の値に置き換える）。

```sql
INSERT INTO auth_profiles (auth_uid, app_user_id, email)
VALUES ('ここにUUID', 'teacher-1', '先生のメール')
ON CONFLICT (auth_uid) DO UPDATE SET app_user_id = EXCLUDED.app_user_id, email = EXCLUDED.email;
```

4. 本番アプリの「先生ログイン」で、そのメール・パスワードで入れるか試す。

---

## 本番アプリの読み込みに時間がかかる・エラーが起きている？

最初の表示や「名前を選択して入る」が遅い場合、**Supabase へのリクエスト**が遅いか、失敗している可能性があります。

1. **ブラウザの開発者ツールで確認**  
   - **F12** → **Network（ネットワーク）** タブを開く。  
   - ページを再読み込みし、  
     - `supabase.co` やプロジェクト URL 向けのリクエストが **Pending のまま長時間止まっていないか**  
     - **Failed（失敗）** や **4xx/5xx** になっていないか  
   を確認する。

2. **考えられる原因**  
   - Supabase のリージョンと利用者の距離（海外リージョンだと遅くなりやすい）  
   - 無料プランの Cold Start（しばらく使っていないと 1 回目が遅い）  
   - 環境変数ミスで別プロジェクトや無効な URL に繋がっている  
   - 上記の「タイムアウト」と同様、プロジェクトが Paused になっている  

3. **エラーが出ている場合**  
   - **Console（コンソール）** タブに赤いエラーが出ていないか確認する。  
   - 出ているメッセージや、Network で失敗している URL をメモしておくと、原因を絞り込みやすいです。

---

## まとめ

| こと | 確認・対応 |
|------|------------|
| 先生アカウントの「登録」 | 画面上の新規登録はなし。過去に登録済みか、Supabase ダッシュボードでユーザー＋auth_profiles を用意する。 |
| 先生ログインのタイムアウト | 環境変数・Supabase の停止状態・先生アカウントの有無・ネットワークを確認。 |
| **env・Paused は問題ないのに先生ログインできない・名前が表示されない** | **本番 Supabase にマイグレーションが未適用の可能性が高い。** Table Editor で app_users の中身を確認し、空なら上記「本番にマイグレーションを適用する」を実行。先生だけできない場合は auth_profiles に teacher-1 の行があるか確認し、なければ「先生アカウントを 1 件だけ用意する」を実行。 |
| 本番の読み込みが遅い | Network で Supabase へのリクエストが遅れていないか・失敗していないかを確認。 |
