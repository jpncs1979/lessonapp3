# 同じデータを全デバイスで見る手順（初心者向け）

パソコン・iPhone・Line など、どの端末で開いても**同じ名簿・同じスケジュール**が表示されるようにする手順です。  
「Supabase（スーパーベース）」という無料のサービスでデータを保存し、全デバイスで共有します。

---

## 全体の流れ（5ステップ）

1. Supabase のアカウントを作る  
2. Supabase で「プロジェクト」を作り、URL と鍵を控える  
3. Supabase に「テーブル」を作る（SQL を1回実行する）  
4. メール確認をオフにする（登録後すぐログインできるようにする）  
5. Vercel に「環境変数」を2つ登録して、もう一度デプロイする  

ここまで終わると、本番の URL（例：https://lessonapp3.vercel.app）で、どの端末から開いても同じデータになります。

---

## ステップ1：Supabase のアカウントを作る

1. パソコンのブラウザで **https://supabase.com** を開く  
2. 右上の **Start your project** をクリック  
3. **Sign in with GitHub** を選ぶ（GitHub のアカウントでログイン）  
   - GitHub のアカウントがない場合は、先に [github.com](https://github.com) で無料登録する  
4. 初回だけ「Supabase が GitHub の情報にアクセスしてよいか」と出たら **Authorize** を押す  

これで Supabase にログインした状態になります。

---

## ステップ2：Supabase で「プロジェクト」を作り、URL と鍵を控える

### 2-1. プロジェクトを作る

1. Supabase の画面で **New project** をクリック  
2. **Organization** はそのまま（最初は1つだけある）  
3. **Name** に、わかりやすい名前を入れる（例：`lessonapp`）  
4. **Database Password** に、自分で決めたパスワードを入れる  
   - これは「データベース用」のパスワードで、忘れないようにメモしておく  
5. **Region** は「 Northeast Asia (Tokyo) 」など、日本に近いものを選ぶ  
6. 下の **Create new project** をクリック  
7. 1〜2分ほど待つ（「Setting up your project...」と出ている間は待つ）

### 2-2. URL と「anon key」を控える

プロジェクトができたら、次の操作で **URL** と **鍵（キー）** を控えます。  
この2つをあとで Vercel に入力します。

1. 左のメニューで **⚙️ Project Settings**（歯車のアイコン）をクリック  
2. 左のメニューで **API** をクリック  
3. 画面の **Project URL** のところに、  
   `https://xxxxxxxxxxxx.supabase.co` のようなアドレスが表示されている  
   → これを**コピー**して、メモ帳などに貼り付けておく  
4. 少し下に **Project API keys** という欄がある  
5. その中の **anon** **public** と書いてある行の **Reveal** をクリック  
6. 長い文字列（英数字がずらっと並んだもの）が表示される  
   → これを**コピー**して、メモ帳などに貼り付けておく  

ここで控えた2つを、後でこう使います。

- **Project URL** → Vercel の「環境変数」の `NEXT_PUBLIC_SUPABASE_URL` に入れる  
- **anon public の長い文字列** → Vercel の「環境変数」の `NEXT_PUBLIC_SUPABASE_ANON_KEY` に入れる  

---

## ステップ3：Supabase に「テーブル」を作る（SQL を1回実行する）

アプリが使う「名簿」「レッスン」「スケジュール」などを保存するための表（テーブル）を、Supabase に作ります。  
方法は「SQL を1回実行する」だけです。

1. このプロジェクトのフォルダ（lessonapp3）を Cursor やメモ帳で開く  
2. 次のファイルを開く：  
   **supabase** フォルダ → **migrations** フォルダ → **20250222000000_sync_schema.sql**  
3. そのファイルの**中身をすべて**選択してコピーする（Ctrl+A → Ctrl+C）  
4. ブラウザで Supabase の画面に戻る  
5. 左のメニューで **SQL Editor** をクリック  
6. **New query** をクリック  
7. 真っ白な欄に、さきほどコピーした SQL の内容を**貼り付ける**（Ctrl+V）  
8. 右下の **Run** ボタン（または Ctrl+Enter）を押す  
9. 下に「Success. No rows returned」などと出れば成功  
10. **もう1本**実行する：**New query** を押し、今度は **supabase/migrations/20250222100000_auth_profiles_trigger.sql** を開いて中身をすべてコピーし、SQL Editor に貼り付けて **Run** する  

これでテーブルができ、初期の名簿（先生・生徒・伴奏者）も入っています。  
2本目の SQL は「登録したときに auth_profiles に1行入れる」ためのもので、実行しないとアカウント登録でエラーになります。

---

## ステップ4：メール確認をオフにする（任意）

標準のままだと「登録したあと、メールのリンクを押さないとログインできない」になります。  
「登録したらすぐログインできる」ようにするには、次の設定をします。

1. Supabase の左のメニューで **Authentication** をクリック  
2. 上にある **Providers** タブをクリック  
3. 一覧の中の **Email** の行の右側にある **設定（歯車など）** をクリック  
4. **Confirm email** という項目のスイッチを**オフ**にする  
5. **Save** を押す  

これで、名前を選んでメール・パスワードを登録したあと、その場ですぐログインできるようになります。

---

## ステップ5：Vercel に「環境変数」を2つ登録して、もう一度デプロイする

いまインターネットで公開しているサイト（例：lessonapp3.vercel.app）が、Supabase のデータを使うようにします。  
そのために「環境変数」を2つ登録し、「Redeploy」でサイトをやり直します。

### 5-1. Vercel にログインする

1. ブラウザで **https://vercel.com** を開く  
2. ログインする（GitHub でログインしていることが多い）  
3. 一覧から **lessonapp3**（またはこのアプリの名前）のプロジェクトをクリック  

### 5-2. 環境変数を2つ追加する

1. 画面上方の **Settings** をクリック  
2. 左のメニューから **Environment Variables** をクリック  
3. **Key** の欄に次の文字を**そのまま**入力する：  
   `NEXT_PUBLIC_SUPABASE_URL`  
4. **Value** の欄に、ステップ2で控えた **Project URL**（`https://xxxx.supabase.co`）を貼り付ける  
5. **Save** をクリック  
6. もう1つ追加する：**Add Another** または **New** をクリック  
7. **Key** に：  
   `NEXT_PUBLIC_SUPABASE_ANON_KEY`  
8. **Value** に、ステップ2で控えた **anon public の長い文字列**を貼り付ける  
9. **Save** をクリック  

これで「このサイトは Supabase のこのプロジェクトを使う」と Vercel に伝わりました。

### 5-3. サイトを「Redeploy」する

環境変数を追加しただけでは、すでに動いているサイトには反映されません。  
「もう一度デプロイする」必要があります。

1. 画面上方の **Deployments** をクリック  
2. いちばん上にある「最新のデプロイ」の行の、右側の **⋯**（3点リーダー）をクリック  
3. 出てきたメニューから **Redeploy** をクリック  
4. 確認画面で **Redeploy** をもう一度クリック  
5. 数十秒〜1分ほど待つ（Status が **Ready** になれば完了）  

これで、本番の URL（例：https://lessonapp3.vercel.app）は「Supabase のデータを使う設定」で動いています。

---

## 使い方の確認（全デバイスで同じデータになるか）

1. **パソコンのブラウザ**で、本番の URL（例：https://lessonapp3.vercel.app）を開く  
2. 名前を選んで、まだなら「登録する」でメール・パスワードを設定し、ログインする  
3. 名簿やカレンダーを少し変更する（例：レッスン日を1つ追加する）  
4. **iPhone の Safari** や **Line のブラウザ**で、**同じ URL** を開く  
5. 「名前を選択して入る」画面になったら、**「名前を選択して入る / 登録」の下にある「メール・パスワードでログイン」** の画面に進み、**同じメール・パスワード**でログインする  
6. パソコンで入れた変更（名簿・スケジュールなど）が、iPhone や Line でも同じように表示されていれば成功  

※ 各端末で「同じメール・パスワード」でログインすると、同じ Supabase のデータが見えます。

---

## うまくいかないとき

- **「名前を選択」の一覧が空**  
  → ステップ3の SQL が実行できていない可能性があります。SQL Editor でもう一度 Run してください。  
- **Line や iPhone でまだ古いデータ**  
  → ステップ5の「環境変数を追加したあとに Redeploy」を忘れていないか確認してください。Redeploy しないと反映されません。  
  → もう一度、本番 URL を開き直し、メール・パスワードでログインし直してみてください。  
- **登録したのにログインできない**  
  → ステップ4で「Confirm email」をオフにしたか確認してください。オフにしていないと、メールのリンクを押すまでログインできません。  

---

## まとめ

| やること | どこで |
|----------|--------|
| Supabase のアカウント作成 | supabase.com |
| プロジェクト作成＆URL・鍵を控える | Supabase の Project Settings → API |
| テーブルを作る | Supabase の SQL Editor で 20250222000000_sync_schema.sql を実行 |
| メール確認オフ（任意） | Supabase の Authentication → Providers → Email |
| 環境変数2つを登録 | Vercel の Settings → Environment Variables |
| Redeploy | Vercel の Deployments → ⋯ → Redeploy |

ここまで終われば、パソコン・iPhone・Line のどれで開いても、同じデータが表示されます。
