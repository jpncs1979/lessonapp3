# ログイン仕様書

## メールアドレスを登録する必要がある理由

「名前は名簿で決まっているのに、なぜメールアドレスまで登録するのか」という疑問への回答です。

- **「誰がログインしているか」を判別するため**  
  名簿には「田中 花子」「鈴木 太郎」など複数の名前があります。  
  パソコン・iPhone・Line など**別の端末**から開いたときに、「今ログインしているのが名簿の誰か」を判断するには、名前だけでは足りません。  
  そのために **メールアドレスとパスワード** を「この名前の本人だけが知っているもの」として登録してもらい、ログインのときにそれを入力してもらっています。

- **複数デバイスで同じデータを見るとき**  
  Supabase を使うと、どの端末から開いても同じデータが表示されます。  
  そのとき「同じ人」と分かるようにするため、**同じメール・パスワード**でログインする仕組みにしています。  
  メールアドレスを登録していないと、別の端末では「誰か」が分からず、同じデータにアクセスできません。

- **メールを「送る」用途ではない**  
  このアプリでは、登録したメールアドレスに**お知らせメールを送ったりはしていません**。  
  あくまで「本人確認用の ID」として使っています。

まとめると、「名前」は名簿で決まっていて、「メール・パスワード」はその名前の**本人だけがログインできるようにするための鍵**として使っています。

---

## 1. 現在の動作（実装済み）

### 誰がログインできるか

- **先生が名簿に登録した人だけ**がログインできます。
- 名簿＝「名簿管理」で登録した **学生** と **伴奏者**、および **先生**（1名）です。
- 名簿にいない人は名前選択画面の「名前」の一覧にも出ませんし、ログインできません。

### 名前を選択して入る（登録 or ログイン）

1. ログイン画面の **「名前を選択して入る / 登録」** から名前選択ページへ進む（または `/register` に直接アクセス）。
2. **あなたの名前** をドロップダウンで選択する。  
   → 出てくるのは「先生」「名簿に登録されている生徒」「名簿に登録されている伴奏者」だけです。
3. **まだ登録していない名前** を選んだ場合：**メールアドレス** と **パスワード**（6文字以上）・**パスワード（確認）** を入力し、**「登録する」** を押すと、その名前とメール・パスワードが紐付き、そのままログインしてカレンダーへ遷移します。
4. **すでに登録済みの名前** を選んだ場合：**「ログイン」** ボタンが表示され、押すとそのアカウントでログインしてカレンダーへ遷移します。

### ログイン（メール・パスワード）

1. ログイン画面で **メールアドレス** と **パスワード** を入力する。
2. **「ログイン」** を押す。
3. 次のどれかに当てはまるとログインできません。
   - メールまたはパスワードが違う
   - そのメールで登録した「名前」が、今の名簿（先生・生徒・伴奏者）にいない  
     → 例：先生が名簿からその生徒を削除した場合、「このアカウントは名簿に登録されていません」と表示されます。

### 技術的な扱い

- **認証情報の保存**  
  メールとパスワードのハッシュ（SHA-256）をブラウザの **localStorage**（キー: `lessonapp_credentials`）に保存しています。  
  サーバーには送っていません。
- **パスワード**  
  画面では「6文字以上」必須。保存するのはハッシュのみで、プレーンテキストは保存しません。
- **名簿との一致**  
  ログイン時に、そのメールに紐づく「ユーザーID」が、現在の `state.users`（先生＋名簿の生徒・伴奏者）に含まれているかだけチェックしています。名簿から外れていればログイン不可です。

---

## 2. 本番運用で Supabase 等を使う場合（参考）

将来的に「複数端末で同じデータを見たい」「認証をサーバー側でやりたい」場合は、Supabase Auth と DB を導入する想定です。

- **Supabase Auth**  
  メール・パスワードやマジックリンクを Supabase に任せ、ログイン状態をサーバー側で管理します。
- **名簿との対応**  
  Supabase の `users` テーブル（または `auth.users` と紐付いたテーブル）に「先生が登録した生徒・伴奏者」を持たせ、  
  「ログインできた＝そのテーブルにいる人」という制御にすると、今の「名簿にいる人だけログインできる」仕様を維持できます。

現在のアプリは **localStorage のみ** のため、環境変数や Supabase の設定は **不要** です。  
上記は「本番でサーバー認証に切り替えるときの方針」として記載しています。
