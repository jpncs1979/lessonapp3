# ログイン仕様書

## 1. 現在の動作（実装済み）

### 誰がログインできるか

- **先生が名簿に登録した人だけ**がログインできます。
- 名簿＝「名簿管理」で登録した **学生** と **伴奏者**、および **先生**（1名）です。
- 名簿にいない人は初回登録の「名前」の一覧にも出ませんし、ログインできません。

### 初回登録（メール・パスワードの設定）

1. ログイン画面の **「初回の方はこちら」** から **初回登録** ページへ進む。
2. **あなたの名前** をドロップダウンで選択する。  
   → 出てくるのは「先生」「名簿に登録されている生徒」「名簿に登録されている伴奏者」だけです。
3. まだ登録していない名前を選んだ場合、**メールアドレス** と **パスワード**（6文字以上）・**パスワード（確認）** を入力する。
4. **「登録してログイン」** を押すと、その名前とメール・パスワードが紐付き、そのままログインしてカレンダーへ遷移します。
5. 同じ名前で2回目以降は「このアカウントは登録済みです。ログイン画面へ」と表示され、ログイン画面からメール・パスワードで入る形になります。

### ログイン（2回目以降）

1. ログイン画面で **メールアドレス** と **パスワード** を入力する。
2. **「ログイン」** を押す。
3. 次のどれかに当てはまるとログインできません。
   - メールまたはパスワードが違う
   - そのメールで登録した「名前」が、今の名簿（先生・生徒・伴奏者）にいない  
     → 例：先生が名簿からその生徒を削除した場合、「このアカウントは名簿に登録されていません」と表示されます。

### 技術的な扱い

- **認証情報の保存**  
  メールとパスワードのハッシュ（SHA-256）をブラウザの **localStorage**（キー: `lessonapp_credentials`）に保存しています。  
  サーバーには送っていません。
- **パスワード**  
  画面では「6文字以上」必須。保存するのはハッシュのみで、プレーンテキストは保存しません。
- **名簿との一致**  
  ログイン時に、そのメールに紐づく「ユーザーID」が、現在の `state.users`（先生＋名簿の生徒・伴奏者）に含まれているかだけチェックしています。名簿から外れていればログイン不可です。

---

## 2. 本番運用で Supabase 等を使う場合（参考）

将来的に「複数端末で同じデータを見たい」「認証をサーバー側でやりたい」場合は、Supabase Auth と DB を導入する想定です。

- **Supabase Auth**  
  メール・パスワードやマジックリンクを Supabase に任せ、ログイン状態をサーバー側で管理します。
- **名簿との対応**  
  Supabase の `users` テーブル（または `auth.users` と紐付いたテーブル）に「先生が登録した生徒・伴奏者」を持たせ、  
  「ログインできた＝そのテーブルにいる人」という制御にすると、今の「名簿にいる人だけログインできる」仕様を維持できます。

現在のアプリは **localStorage のみ** のため、環境変数や Supabase の設定は **不要** です。  
上記は「本番でサーバー認証に切り替えるときの方針」として記載しています。
